"""
–ü–∞—Ä—Å–µ—Ä –¥–ª—è API –ø–æ—Ä—Ç–∞–ª–∞ goszakup.gov.kz
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç GraphQL API –¥–ª—è –ø–æ–∏—Å–∫–∞ –ª–æ—Ç–æ–≤ –∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
"""
import requests
import json
from typing import List, Dict, Optional
from datetime import datetime, timedelta
import time
import sys
import os

sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from config import GOSZAKUP_API_URL, GOSZAKUP_API_TOKEN, ALL_KEYWORDS, RESULTS_PER_PAGE


class GoszakupParser:
    """–ü–∞—Ä—Å–µ—Ä –¥–ª—è –ø–æ—Ä—Ç–∞–ª–∞ –≥–æ—Å–∑–∞–∫—É–ø–æ–∫ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞"""

    def __init__(self):
        self.graphql_url = GOSZAKUP_API_URL
        self.rest_api_base = "https://ows.goszakup.gov.kz/v3"
        self.session = requests.Session()

        # –ë–∞–∑–æ–≤—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
        headers = {
            'Content-Type': 'application/json',
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        }

        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        if GOSZAKUP_API_TOKEN:
            headers['Authorization'] = f'Bearer {GOSZAKUP_API_TOKEN}'

        self.session.headers.update(headers)

    def search_lots(self, keywords: List[str], days_back: int = 7) -> List[Dict]:
        """
        –ü–æ–∏—Å–∫ –ª–æ—Ç–æ–≤ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –¥–Ω–µ–π

        Args:
            keywords: –°–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞
            days_back: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –Ω–∞–∑–∞–¥ –¥–ª—è –ø–æ–∏—Å–∫–∞

        Returns:
            –°–ø–∏—Å–æ–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ª–æ—Ç–æ–≤ —Å –¥–∞–Ω–Ω—ã–º–∏
        """
        print(f"üîç –ü–æ–∏—Å–∫ –ª–æ—Ç–æ–≤ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º: {', '.join(keywords)}")

        start_date = (datetime.now() - timedelta(days=days_back)).strftime('%Y-%m-%d')
        found_lots = []

        # –ò—Å–ø–æ–ª—å–∑—É–µ–º REST API v3 –¥–ª—è –ø–æ–∏—Å–∫–∞ –ª–æ—Ç–æ–≤
        # Endpoint: /lots
        lots_url = f"{self.rest_api_base}/lots"

        params = {
            'limit': RESULTS_PER_PAGE,
            'offset': 0
        }

        try:
            response = self.session.get(lots_url, params=params, timeout=30)
            response.raise_for_status()
            data = response.json()

            if 'items' in data:
                for lot in data['items']:
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –ª–æ—Ç–∞
                    lot_name = lot.get('name_ru', '').lower()
                    lot_desc = lot.get('description_ru', '').lower()

                    matched_keyword = None
                    for keyword in keywords:
                        if keyword.lower() in lot_name or keyword.lower() in lot_desc:
                            matched_keyword = keyword
                            break

                    if matched_keyword:
                        # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ª–æ—Ç–∞
                        lot_data = self._extract_lot_data(lot, matched_keyword)
                        if lot_data:
                            found_lots.append(lot_data)
                            print(f"‚úÖ –ù–∞–π–¥–µ–Ω –ª–æ—Ç: {lot_data['lot_name'][:50]}...")

            print(f"üìä –í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ –ª–æ—Ç–æ–≤: {len(found_lots)}")
            return found_lots

        except requests.RequestException as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –ª–æ—Ç–æ–≤: {e}")
            return []

    def _extract_lot_data(self, lot: Dict, keyword: str) -> Optional[Dict]:
        """–ò–∑–≤–ª–µ—á—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ª–æ—Ç–∞"""
        try:
            # –ü–æ–ª—É—á–∞–µ–º –Ω–æ–º–µ—Ä –æ–±—ä—è–≤–ª–µ–Ω–∏—è
            trd_buy_id = lot.get('trd_buy_id')
            if not trd_buy_id:
                print(f"‚ö†Ô∏è –£ –ª–æ—Ç–∞ –Ω–µ—Ç trd_buy_id")
                return None

            print(f"üîç –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –æ–±—ä—è–≤–ª–µ–Ω–∏—è {trd_buy_id}...")

            # –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
            announcement_data = self.get_announcement_details(trd_buy_id)
            if not announcement_data:
                print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è {trd_buy_id}")
                return None

            kato_code = announcement_data.get('kato_code', '')
            customer_name = announcement_data.get('customer_name', 'N/A')
            customer_bin = announcement_data.get('customer_bin', 'N/A')

            # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å –ø–æ –ë–ò–ù
            print(f"üè¢ –ó–∞–ø—Ä–æ—Å –∞–¥—Ä–µ—Å–∞ –¥–ª—è –ë–ò–ù: {customer_bin}")
            legal_address = self.get_customer_address(customer_bin)
            print(f"üìç –ü–æ–ª—É—á–µ–Ω–Ω—ã–π –∞–¥—Ä–µ—Å: {legal_address}")

            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–≥–∏–æ–Ω: —Å–Ω–∞—á–∞–ª–∞ –∏–∑ –∞–¥—Ä–µ—Å–∞, –ø–æ—Ç–æ–º –∏–∑ KATO
            print(f"üîç –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞ –∏–∑ –∞–¥—Ä–µ—Å–∞: '{legal_address}'")
            region = self._extract_region(legal_address)
            print(f"   –†–µ–∑—É–ª—å—Ç–∞—Ç: '{region}'")

            if region in ['–î—Ä—É–≥–æ–π —Ä–µ–≥–∏–æ–Ω', '–ù–µ —É–∫–∞–∑–∞–Ω']:
                # –§–æ–ª–ª–±—ç–∫ –Ω–∞ KATO
                print(f"   ‚ö†Ô∏è –†–µ–≥–∏–æ–Ω –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∏–∑ –∞–¥—Ä–µ—Å–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º KATO")
                region = self._extract_region_from_kato(kato_code)
            else:
                print(f"   ‚úÖ –†–µ–≥–∏–æ–Ω –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∏–∑ –∞–¥—Ä–µ—Å–∞: {region}")

            # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            return {
                'announcement_number': announcement_data.get('number_anno', 'N/A'),
                'announcement_url': f"https://goszakup.gov.kz/ru/announce/index/{trd_buy_id}",
                'organization_name': customer_name,
                'organization_bin': customer_bin,
                'legal_address': legal_address,
                'region': region,
                'lot_name': lot.get('name_ru', 'N/A'),
                'lot_description': lot.get('description_ru', ''),
                'keyword_matched': keyword
            }

        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ª–æ—Ç–∞: {e}")
            return None

    def get_customer_address(self, customer_bin: str) -> str:
        """
        –ü–æ–ª—É—á–∏—Ç—å —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ –ë–ò–ù

        Args:
            customer_bin: –ë–ò–ù –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏

        Returns:
            –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å
        """
        if not customer_bin or customer_bin == 'N/A':
            return '–ù–µ —É–∫–∞–∑–∞–Ω'

        url = f"{self.rest_api_base}/subject/biin/{customer_bin}/address"

        try:
            response = self.session.get(url, timeout=10)
            response.raise_for_status()
            data = response.json()

            if 'items' in data and len(data['items']) > 0:
                # –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –∞–¥—Ä–µ—Å (–æ–±—ã—á–Ω–æ —ç—Ç–æ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å)
                address = data['items'][0].get('address', '–ù–µ —É–∫–∞–∑–∞–Ω')
                print(f"   ‚úì –ü–æ–ª—É—á–µ–Ω –∞–¥—Ä–µ—Å –ø–æ –ë–ò–ù {customer_bin}: {address}")
                return address
            else:
                print(f"   ‚ö†Ô∏è –ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –ë–ò–ù {customer_bin}")
                return '–ù–µ —É–∫–∞–∑–∞–Ω'

        except Exception as e:
            print(f"   ‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∞–¥—Ä–µ—Å–∞ –¥–ª—è –ë–ò–ù {customer_bin}: {e}")
            return '–ù–µ —É–∫–∞–∑–∞–Ω'

    def get_announcement_details(self, trd_buy_id: int) -> Optional[Dict]:
        """
        –ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –ø–æ ID

        Args:
            trd_buy_id: ID –æ–±—ä—è–≤–ª–µ–Ω–∏—è

        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
        """
        url = f"{self.rest_api_base}/trd-buy/{trd_buy_id}"

        try:
            response = self.session.get(url, timeout=30)
            response.raise_for_status()
            data = response.json()

            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ—Ç–≤–µ—Ç–∞
            kato_raw = data.get('kato', '')
            # KATO –º–æ–∂–µ—Ç –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º, –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç
            if isinstance(kato_raw, list) and kato_raw:
                kato_code = str(kato_raw[0])
            else:
                kato_code = str(kato_raw) if kato_raw else ''

            customer_name = data.get('customer_name_ru') or data.get('org_name_ru', 'N/A')
            customer_bin = data.get('customer_bin') or data.get('org_bin', None)

            print(f"üìã –î–∞–Ω–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è {trd_buy_id}:")
            print(f"   - KATO (—Å—ã—Ä–æ–π): {kato_raw}")
            print(f"   - KATO (–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π): {kato_code}")
            print(f"   - –ë–ò–ù: {customer_bin}")
            print(f"   - –ó–∞–∫–∞–∑—á–∏–∫: {customer_name}")

            return {
                'number_anno': data.get('number_anno', 'N/A'),
                'customer_name': customer_name,
                'customer_bin': customer_bin,
                'kato_code': kato_code,
                'customer_region': 'N/A'  # –ë—É–¥–µ–º –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –ø–æ KATO
            }

        except requests.RequestException as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–µ—Ç–∞–ª–µ–π –æ–±—ä—è–≤–ª–µ–Ω–∏—è {trd_buy_id}: {e}")
            # –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± —á–µ—Ä–µ–∑ GraphQL
            return self._get_announcement_graphql(trd_buy_id)

    def _get_announcement_graphql(self, trd_buy_id: int) -> Optional[Dict]:
        """–ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ GraphQL"""
        query = """
        query($id: Int!) {
            trd_buy(id: $id) {
                id
                number_anno
                name_ru
                customer {
                    bin
                    name_ru
                    legal_address
                    region {
                        name_ru
                    }
                }
            }
        }
        """

        variables = {"id": trd_buy_id}

        try:
            response = self.session.post(
                self.graphql_url,
                json={'query': query, 'variables': variables},
                timeout=30
            )
            response.raise_for_status()
            data = response.json()

            if 'data' in data and data['data'].get('trd_buy'):
                buy_data = data['data']['trd_buy']
                customer = buy_data.get('customer', {})

                # –õ–æ–≥–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö GraphQL
                print(f"üìã –î–∞–Ω–Ω—ã–µ GraphQL:")
                print(f"   - customer: {customer}")
                print(f"   - legal_address: {customer.get('legal_address', '–ù–ï–¢')}")
                print(f"   - region: {customer.get('region', '–ù–ï–¢')}")

                return {
                    'number_anno': buy_data.get('number_anno', 'N/A'),
                    'customer_name': customer.get('name_ru', 'N/A'),
                    'customer_bin': customer.get('bin', 'N/A'),
                    'customer_address': customer.get('legal_address', 'N/A'),
                    'customer_region': customer.get('region', {}).get('name_ru', 'N/A')
                }

        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ GraphQL –∑–∞–ø—Ä–æ—Å–∞: {e}")
            return None

    def _extract_region_from_kato(self, kato_code: str) -> str:
        """
        –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–µ–≥–∏–æ–Ω –ø–æ –∫–æ–¥—É KATO

        Args:
            kato_code: –ö–æ–¥ –ö–ê–¢–û (–ø–µ—Ä–≤—ã–µ 2 —Ü–∏—Ñ—Ä—ã –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç —Ä–µ–≥–∏–æ–Ω)

        Returns:
            –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞
        """
        if not kato_code or len(kato_code) < 2:
            return "–ù–µ —É–∫–∞–∑–∞–Ω"

        # –ü–µ—Ä–≤—ã–µ 2 —Ü–∏—Ñ—Ä—ã KATO - –∫–æ–¥ —Ä–µ–≥–∏–æ–Ω–∞
        region_code = kato_code[:2]

        print(f"üîç –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞ –ø–æ KATO: {kato_code} (–∫–æ–¥ —Ä–µ–≥–∏–æ–Ω–∞: {region_code})")

        # –ú–∞–ø–ø–∏–Ω–≥ –∫–æ–¥–æ–≤ KATO –Ω–∞ —Ä–µ–≥–∏–æ–Ω—ã –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞
        # –í–∫–ª—é—á–∞—è –æ—Å–Ω–æ–≤–Ω—ã–µ –∏ —Ä–∞–π–æ–Ω–Ω—ã–µ –∫–æ–¥—ã
        kato_regions = {
            '01': '–ê–∫–º–æ–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '02': '–ê–∫—Ç—é–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '03': '–ê–ª–º–∞—Ç–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '04': '–ê—Ç—ã—Ä–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '05': '–í–æ—Å—Ç–æ—á–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '06': '–ñ–∞–º–±—ã–ª—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '07': '–ó–∞–ø–∞–¥–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '08': '–ö–∞—Ä–∞–≥–∞–Ω–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '09': '–ö–æ—Å—Ç–∞–Ω–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '10': '–ö—ã–∑—ã–ª–æ—Ä–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '11': '–ú–∞–Ω–≥–∏—Å—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '15': '–ü–∞–≤–ª–æ–¥–∞—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '16': '–°–µ–≤–µ—Ä–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '17': '–¢—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '19': '–ê–±–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '20': '–ñ–µ—Ç—ñ—Å—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '21': '–£–ª—ã—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '71': '–≥. –ê—Å—Ç–∞–Ω–∞',
            '75': '–≥. –ê–ª–º–∞—Ç—ã',
            '79': '–≥. –®—ã–º–∫–µ–Ω—Ç',

            # –†–∞–π–æ–Ω–Ω—ã–µ –∫–æ–¥—ã (–Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å –¥—Ä—É–≥–∏—Ö —Ü–∏—Ñ—Ä)
            '43': '–ê—Ç—ã—Ä–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',    # –†–∞–π–æ–Ω—ã –ê—Ç—ã—Ä–∞—É—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏
            '44': '–ê—Ç—ã—Ä–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '45': '–ê—Ç—ã—Ä–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '55': '–ü–∞–≤–ª–æ–¥–∞—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',  # –†–∞–π–æ–Ω—ã –ü–∞–≤–ª–æ–¥–∞—Ä—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏
            '56': '–ü–∞–≤–ª–æ–¥–∞—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '61': '–¢—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',  # –Æ–∂–Ω—ã–µ —Ä–µ–≥–∏–æ–Ω—ã
            '62': '–¢—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '63': '–í–æ—Å—Ç–æ—á–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å'  # –í–æ—Å—Ç–æ—á–Ω—ã–µ —Ä–µ–≥–∏–æ–Ω—ã
        }

        region = kato_regions.get(region_code, '–î—Ä—É–≥–æ–π —Ä–µ–≥–∏–æ–Ω')
        print(f"‚úÖ –†–µ–≥–∏–æ–Ω –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –ø–æ KATO: {region}")
        return region

    def _extract_region(self, address: str) -> str:
        """
        –ò–∑–≤–ª–µ—á—å —Ä–µ–≥–∏–æ–Ω –∏–∑ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –∞–¥—Ä–µ—Å–∞

        Args:
            address: –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å

        Returns:
            –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞
        """
        if not address:
            return "–ù–µ —É–∫–∞–∑–∞–Ω"

        address_lower = address.lower()

        # –°–ø–∏—Å–æ–∫ –æ–±–ª–∞—Å—Ç–µ–π –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞ —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –Ω–∞–ø–∏—Å–∞–Ω–∏—è
        regions_map = {
            # –ê–ª–º–∞—Ç—ã –∏ –ê–ª–º–∞—Ç–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
            '–∞–ª–º–∞—Ç–∏–Ω—Å–∫–∞—è': '–ê–ª–º–∞—Ç–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '–∞–ª–º–∞—Ç–∏–Ω—Å–∫–∞—è –æ–±–ª': '–ê–ª–º–∞—Ç–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '–∞–ª–º–∞—Ç. –æ–±–ª': '–ê–ª–º–∞—Ç–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '–∞–ª–º–∞—Ç—ã': '–≥. –ê–ª–º–∞—Ç—ã',
            '–≥.–∞–ª–º–∞—Ç—ã': '–≥. –ê–ª–º–∞—Ç—ã',
            '–≥. –∞–ª–º–∞—Ç—ã': '–≥. –ê–ª–º–∞—Ç—ã',
            'almaty': '–≥. –ê–ª–º–∞—Ç—ã',

            # –ê—Å—Ç–∞–Ω–∞
            '–∞—Å—Ç–∞–Ω–∞': '–≥. –ê—Å—Ç–∞–Ω–∞',
            '–≥.–∞—Å—Ç–∞–Ω–∞': '–≥. –ê—Å—Ç–∞–Ω–∞',
            '–≥. –∞—Å—Ç–∞–Ω–∞': '–≥. –ê—Å—Ç–∞–Ω–∞',
            '–Ω—É—Ä-—Å—É–ª—Ç–∞–Ω': '–≥. –ê—Å—Ç–∞–Ω–∞',
            '–∞—Å—Ç–∞–Ω–∏–Ω—Å–∫–∞—è': '–ê—Å—Ç–∞–Ω–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            'astana': '–≥. –ê—Å—Ç–∞–Ω–∞',

            # –ê–∫–º–æ–ª–∏–Ω—Å–∫–∞—è
            '–∞–∫–º–æ–ª–∏–Ω—Å–∫–∞—è': '–ê–∫–º–æ–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '–∞–∫–º–æ–ª–∏–Ω—Å–∫–∞—è –æ–±–ª': '–ê–∫–º–æ–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '–∞–∫–º–æ–ª. –æ–±–ª': '–ê–∫–º–æ–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '–∞–∫–º–æ–ª–∞': '–ê–∫–º–æ–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',

            # –¢—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–∞—è
            '—Ç—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–∞—è': '–¢—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '—Ç—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª': '–¢—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '—Ç—É—Ä–∫–µ—Å—Ç–∞–Ω': '–¢—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',

            # –®—ã–º–∫–µ–Ω—Ç
            '—à—ã–º–∫–µ–Ω—Ç': '–≥. –®—ã–º–∫–µ–Ω—Ç',
            '–≥.—à—ã–º–∫–µ–Ω—Ç': '–≥. –®—ã–º–∫–µ–Ω—Ç',
            '–≥. —à—ã–º–∫–µ–Ω—Ç': '–≥. –®—ã–º–∫–µ–Ω—Ç',
            'shymkent': '–≥. –®—ã–º–∫–µ–Ω—Ç',

            # –û—Å—Ç–∞–ª—å–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏
            '–∞–∫—Ç—é–±–∏–Ω—Å–∫–∞—è': '–ê–∫—Ç—é–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '–∞–∫—Ç—é–±–∏–Ω—Å–∫–∞—è –æ–±–ª': '–ê–∫—Ç—é–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '–∞–∫—Ç–æ–±–µ': '–ê–∫—Ç—é–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',

            '–∞—Ç—ã—Ä–∞—É—Å–∫–∞—è': '–ê—Ç—ã—Ä–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '–∞—Ç—ã—Ä–∞—É—Å–∫–∞—è –æ–±–ª': '–ê—Ç—ã—Ä–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '–∞—Ç—ã—Ä–∞—É': '–ê—Ç—ã—Ä–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',

            '–≤–æ—Å—Ç–æ—á–Ω–æ-–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è': '–í–æ—Å—Ç–æ—á–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '–≤–∫–æ': '–í–æ—Å—Ç–æ—á–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '—É—Å—Ç—å-–∫–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫': '–í–æ—Å—Ç–æ—á–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',

            '–∂–∞–º–±—ã–ª—Å–∫–∞—è': '–ñ–∞–º–±—ã–ª—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '–∂–∞–º–±—ã–ª—Å–∫–∞—è –æ–±–ª': '–ñ–∞–º–±—ã–ª—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '–∂–∞–º–±—ã–ª': '–ñ–∞–º–±—ã–ª—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '—Ç–∞—Ä–∞–∑': '–ñ–∞–º–±—ã–ª—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',

            '–∑–∞–ø–∞–¥–Ω–æ-–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è': '–ó–∞–ø–∞–¥–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '–∑–∫–æ': '–ó–∞–ø–∞–¥–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '—É—Ä–∞–ª—å—Å–∫': '–ó–∞–ø–∞–¥–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',

            '–∫–∞—Ä–∞–≥–∞–Ω–¥–∏–Ω—Å–∫–∞—è': '–ö–∞—Ä–∞–≥–∞–Ω–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '–∫–∞—Ä–∞–≥–∞–Ω–¥–∏–Ω—Å–∫–∞—è –æ–±–ª': '–ö–∞—Ä–∞–≥–∞–Ω–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '–∫–∞—Ä–∞–≥–∞–Ω–¥–∞': '–ö–∞—Ä–∞–≥–∞–Ω–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',

            '–∫–æ—Å—Ç–∞–Ω–∞–π—Å–∫–∞—è': '–ö–æ—Å—Ç–∞–Ω–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '–∫–æ—Å—Ç–∞–Ω–∞–π—Å–∫–∞—è –æ–±–ª': '–ö–æ—Å—Ç–∞–Ω–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '–∫–æ—Å—Ç–∞–Ω–∞–π': '–ö–æ—Å—Ç–∞–Ω–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',

            '–∫—ã–∑—ã–ª–æ—Ä–¥–∏–Ω—Å–∫–∞—è': '–ö—ã–∑—ã–ª–æ—Ä–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '–∫—ã–∑—ã–ª–æ—Ä–¥–∏–Ω—Å–∫–∞—è –æ–±–ª': '–ö—ã–∑—ã–ª–æ—Ä–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '–∫—ã–∑—ã–ª–æ—Ä–¥–∞': '–ö—ã–∑—ã–ª–æ—Ä–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',

            '–º–∞–Ω–≥–∏—Å—Ç–∞—É—Å–∫–∞—è': '–ú–∞–Ω–≥–∏—Å—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '–º–∞–Ω–≥–∏—Å—Ç–∞—É—Å–∫–∞—è –æ–±–ª': '–ú–∞–Ω–≥–∏—Å—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '–º–∞–Ω–≥–∏—Å—Ç–∞—É': '–ú–∞–Ω–≥–∏—Å—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '–∞–∫—Ç–∞—É': '–ú–∞–Ω–≥–∏—Å—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',

            '–ø–∞–≤–ª–æ–¥–∞—Ä—Å–∫–∞—è': '–ü–∞–≤–ª–æ–¥–∞—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '–ø–∞–≤–ª–æ–¥–∞—Ä—Å–∫–∞—è –æ–±–ª': '–ü–∞–≤–ª–æ–¥–∞—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '–ø–∞–≤–ª–æ–¥–∞—Ä': '–ü–∞–≤–ª–æ–¥–∞—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',

            '—Å–µ–≤–µ—Ä–æ-–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è': '–°–µ–≤–µ—Ä–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '—Å–∫–æ': '–°–µ–≤–µ—Ä–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '–ø–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫': '–°–µ–≤–µ—Ä–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',

            '–∞–±–∞–π—Å–∫–∞—è': '–ê–±–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '–∞–±–∞–π—Å–∫–∞—è –æ–±–ª': '–ê–±–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '—Å–µ–º–µ–π': '–ê–±–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',

            '–∂–µ—Ç—ñ—Å—É—Å–∫–∞—è': '–ñ–µ—Ç—ñ—Å—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '–∂–µ—Ç—ñ—Å—É': '–ñ–µ—Ç—ñ—Å—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '—Ç–∞–ª–¥—ã–∫–æ—Ä–≥–∞–Ω': '–ñ–µ—Ç—ñ—Å—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',

            '—É–ª—ã—Ç–∞—É—Å–∫–∞—è': '–£–ª—ã—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '—É–ª—ã—Ç–∞—É': '–£–ª—ã—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å',
            '–∂–µ–∑–∫–∞–∑–≥–∞–Ω': '–£–ª—ã—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å'
        }

        for key, region in regions_map.items():
            if key in address_lower:
                return region

        return "–î—Ä—É–≥–æ–π —Ä–µ–≥–∏–æ–Ω"


# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä—Å–µ—Ä–∞
if __name__ == '__main__':
    parser = GoszakupParser()

    # –¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫
    test_keywords = ["–º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –∏–∑–¥–µ–ª–∏—è", "–∞—Ä–µ–Ω–¥–∞"]
    results = parser.search_lots(test_keywords, days_back=30)

    print(f"\nüìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:")
    print(f"–ù–∞–π–¥–µ–Ω–æ –ª–æ—Ç–æ–≤: {len(results)}")

    if results:
        print("\n–ü—Ä–∏–º–µ—Ä –ø–µ—Ä–≤–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:")
        first = results[0]
        for key, value in first.items():
            print(f"  {key}: {value}")
